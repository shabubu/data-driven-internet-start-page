<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title></title>

    <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://unpkg.com/create-react-class@15.6.0-rc.0/create-react-class.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://kit.fontawesome.com/3300c9efd2.js"></script>
    <script src="./data.js"></script>

    <link href="style.css" rel="stylesheet" type="text/css">
  </head>

  <body>
    <div id="ddisp"></div>

    <script type="text/babel">
      const Timezones = createReactClass({
        getInitialState() {
          this.interval = setInterval(
            () => {
              this.setState({
                date: new Date(),
              });
            },
            500,
          );

          return {
            date: new Date(),
          };
        },

        render() {
          const {
            time: {
              locale = 'en-US',
              zones = [],
            },
          } = appData;
          const { date } = this.state;
          const timezonesJsx = [];

          zones.forEach(timezone => {
            const timeOptions = {
              timeZone: timezone.region,
              hour: '2-digit',
              minute: '2-digit',
            };
            const dateOptions = {
              timeZone: timezone.region,
              weekday: "short",
              year: 'numeric',
              month: 'short',
              day: '2-digit',
            };

            timezonesJsx.push(
              <li className="timezone-display">
                <h1>{timezone.title}</h1>
                <span>{date.toLocaleString(locale, timeOptions)}</span>
                <span>{date.toLocaleString(locale, dateOptions)}</span>
              </li>
            );
          });

          return (
            <div id="timezone-wrapper">
              <ul>
                {timezonesJsx}
              </ul>
            </div>
          );
        }
      });

      function Logo() {
        const { logo } = appData;
        let innerJsx;

        if (logo) {
          innerJsx = (
            <img
              id="logo"
              src={appData.logo}
            />
          );
        }

        return (
          <div id="logo-wrapper">
            {innerJsx}
          </div>
        );
      }

      const SearchBar = createReactClass({
        getInitialState() {
          const { searchCommands = [] } = appData;
          const selected = searchCommands[0];
          const options = {};

          searchCommands.forEach(searchCommand => (
            options[searchCommand.command] = searchCommand
          ));

          return {
            options,
            searchCommands,
            searchQuery: '',
            selected,
          };
        },

        onChange(event) {
          const {
            target: {
              value,
            },
          } = event;
          const { options } = this.state;

          // check to see if the search term is a command
          if (options[value]) {
            const searchQuery = '';
            const selected = options[value];

            this.setState({
              searchQuery,
              selected,
            });
          } else {
            this.setState({
              searchQuery: value,
            });
          }
        },

        onHelpClick(event) {
          const value = event.target.getAttribute('command');
          const fakeEvent = {
            target: {
              value,
            },
          };

          this.onChange(fakeEvent);
        },

        onSubmit(event) {
          event.preventDefault();

          const {
            searchQuery,
            selected: {
              url,
            },
          } = this.state;

          window.location = `${url}${encodeURIComponent(searchQuery)}`;
        },

        render() {
          const jsx = [];
          const {
            searchCommands,
            searchQuery,
            selected: {
              label,
              url,
            },
          } = this.state;

          if (
            label
            && url
          ) {
            const helpItems = [];

            searchCommands.forEach(option => {
              const {
                command,
                label,
              } = option;

              helpItems.push(
                <li>
                  <span>
                    <span
                      className="command"
                      command={command}
                      onClick={this.onHelpClick}
                    >
                      {command} - {label}
                    </span>
                  </span>
                </li>
              );
            });

            jsx.push(
              <div className="search-block">
                <form
                  id="search-form"
                  onSubmit={this.onSubmit}
                >
                  <input
                    type="text"
                    name="queryString"
                    id="search"
                    autoFocus="autofocus"
                    autoComplete="off"
                    placeholder={`Search ${label}`}
                    onChange={this.onChange}
                    value={searchQuery}
                  />
                  <label htmlFor="search">
                    <span id="search-icon" className="fas fa-search"></span>
                  </label>
                </form>
                <ul id="search-help" className="search-help">
                  {helpItems}
                </ul>
              </div>
            );
          }

          return jsx;
        }
      });

      function HeaderLinks(props) {
        const { headerLinks = [] } = appData;
        const headerLinksJsx = [];

        headerLinks.forEach(headerLink => (
          headerLinksJsx.push(
            <h2>
              <a href={headerLink.url}>
                {headerLink.name}
              </a>
            </h2>
          )
        ));

        return (
          <div id="header-links">
            {headerLinksJsx}
          </div>
        );
      }

      function LinkGroup(props) {
        const {
          title = '',
          links = [],
        } = props;
        const linkItems = [];

        links.forEach(link => (
          linkItems.push(
            <li>
              <a href={link.url}>
                {link.name}
              </a>
            </li>
          )
        ));

        return (
          <div className="link-group">
            <h3>{title}</h3>
            <ul>
              {linkItems}
            </ul>
          </div>
        );
      }

      function LinkGroups() {
        const rowsJsx = [];
        const chunks = [];

        for (let i = 0; i < appData.linkGroups.length; i += 3) {
          chunks.push(
            appData.linkGroups.slice(i, i + 3),
          );
        }

        chunks.forEach(chunk => {
          const dimensions = [];

          chunk.forEach(linkGroupData => {
            dimensions.push(
              <td width="33%">
                <LinkGroup
                  title={linkGroupData.title}
                  links={linkGroupData.links}
                />
              </td>
            );
          });

          // fill chunk to 3
          for (let i = 0; i < (3 - chunk.length); i++) {
            dimensions.push(<td width="33%"></td>);
          }

          rowsJsx.push(
            <tr>
              {dimensions}
            </tr>
          );
        });

        return (
          <div id="link-groups">
            <table>
              <tbody>
                {rowsJsx}
              </tbody>
            </table>
          </div>
        );
      }

      const QuoteOfDay = createReactClass({
        getInitialState() {
          return {
            author: '',
            quote: '',
          };
        },

        componentDidMount() {
          const self = this;
          if (appData.quoteOfTheDay) {
            axios
              .get('http://quotes.rest/qod.json')
              .then(response => {
                const {
                  data: {
                    contents: {
                      quotes: [
                        {
                          author,
                          quote,
                        },
                      ],
                    },
                  },
                } = response;

                if (
                  author
                  && quote
                ) {
                  self.setState({
                    author,
                    quote,
                  });
                }
              });
          }
        },

        render() {
          return (
            <div id="quote-of-day">
              <table>
                <tbody>
                  <tr>
                    <td width="80%">"{this.state.quote}"</td>
                    <td width="20%"> - {this.state.author}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          );
        }
      });

      function App() {
        return (
          <div>
            <Timezones />
            <Logo />
            <SearchBar />
            <HeaderLinks />
            <LinkGroups />
            <QuoteOfDay />
          </div>
        );
      }

      const {
        title,
        background,
        favicon,
      } = appData;

      if (title) {
        document.title = title;
      }

      if (background) {
        document.body.style.background = background;
      }

      if (favicon) {
        const faviconElement = document.createElement('link');
        faviconElement.type = 'image/x-icon';
        faviconElement.rel = 'shortcut icon';
        faviconElement.href = favicon;
        document.getElementsByTagName('head')[0].appendChild(faviconElement);
      }

      ReactDOM.render(
        App(),
        document.getElementById('ddisp'),
      );

    </script>
  </body>
</html>
